#!/usr/bin/env bash
#
# SpecSwift CLI - Command line tool for feature specification
#
# Commands:
#   specswift init <dir>      Create new project with SpecSwift
#   specswift install         Install SpecSwift in existing project
#   specswift update          Update workflows and templates
#   specswift doctor          Check installation
#   specswift help            Show help
#
# Language:
#   Default: English (en)
#   Set SPECSWIFT_LANG=pt for Portuguese
#   Or use --lang pt option
#

set -e

# =============================================================================
# Configuration
# =============================================================================
# Resolve symlinks to get the real script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
SPECSWIFT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LIB_DIR="$SPECSWIFT_ROOT/lib"
VERSION_FILE="$SPECSWIFT_ROOT/VERSION"
VERSION="$(cat "$VERSION_FILE" 2>/dev/null || echo "1.0.0")"

# =============================================================================
# Language Configuration
# =============================================================================
# Default language is English, can be overridden by:
# 1. --lang option (highest priority)
# 2. SPECSWIFT_LANG environment variable
# 3. Default: en
LANG_CODE="${SPECSWIFT_LANG:-en}"

# Get localized string (bash 3.2 compatible - no associative arrays)
L() {
    local key="$1"
    
    if [[ "$LANG_CODE" == "pt" ]]; then
        case "$key" in
            # General
            "unknown_option") echo "Op√ß√£o desconhecida" ;;
            "unknown_command") echo "Comando desconhecido" ;;
            "run_help") echo "Execute 'specswift help' para ver comandos dispon√≠veis" ;;
            # Help
            "usage") echo "USO" ;;
            "commands") echo "COMANDOS" ;;
            "cmd_init") echo "Criar novo projeto com estrutura SpecSwift completa" ;;
            "cmd_install") echo "Instalar SpecSwift em projeto existente (diret√≥rio atual)" ;;
            "cmd_update") echo "Atualizar workflows e templates para vers√£o mais recente" ;;
            "cmd_doctor") echo "Verificar instala√ß√£o e depend√™ncias" ;;
            "cmd_version") echo "Mostrar vers√£o" ;;
            "cmd_help") echo "Mostrar esta ajuda" ;;
            "global_options") echo "OP√á√ïES GLOBAIS" ;;
            "opt_ios") echo "Aplicar configura√ß√µes espec√≠ficas para iOS/Swift" ;;
            "opt_no_git") echo "N√£o inicializar/modificar reposit√≥rio Git" ;;
            "opt_force") echo "Sobrescrever arquivos existentes" ;;
            "opt_verbose") echo "Output detalhado" ;;
            "opt_quiet") echo "Apenas erros" ;;
            "opt_lang") echo "Definir idioma (en/pt)" ;;
            "opt_template") echo "Template do projeto Xcode (swiftui-ios, swiftui-macos)" ;;
            "examples") echo "EXEMPLOS" ;;
            "example_create_ios") echo "# Criar novo projeto iOS" ;;
            "example_install_existing") echo "# Instalar em projeto existente" ;;
            "example_update") echo "# Atualizar workflows" ;;
            "example_check") echo "# Verificar instala√ß√£o" ;;
            "recommended_flow") echo "FLUXO RECOMENDADO" ;;
            "in_windsurf") echo "No Windsurf" ;;
            "documentation") echo "DOCUMENTA√á√ÉO" ;;
            "after_install_see") echo "Ap√≥s instala√ß√£o, veja" ;;
            # Doctor
            "checking_installation") echo "Verificando Instala√ß√£o" ;;
            "workflows") echo "Workflows" ;;
            "templates") echo "Templates" ;;
            "rules") echo "Rules" ;;
            "files") echo "arquivos" ;;
            "tools") echo "Ferramentas" ;;
            "not_found") echo "n√£o encontrado" ;;
            "optional") echo "opcional" ;;
            "required_ios_only") echo "necess√°rio apenas para iOS" ;;
            "optional_ios") echo "opcional para iOS" ;;
            "installed") echo "instalado" ;;
            "current_project") echo "Projeto Atual" ;;
            "workflows_not_installed") echo "Workflows n√£o instalados neste projeto" ;;
            "templates_installed") echo "Templates instalados" ;;
            "templates_not_installed") echo "Templates n√£o instalados" ;;
            "incomplete_install") echo "Instala√ß√£o incompleta. Execute: specswift update" ;;
            "all_ok") echo "Tudo OK!" ;;
            # Init
            "creating_new_project") echo "Criando Novo Projeto" ;;
            "directory") echo "Diret√≥rio" ;;
            "target_dir_not_specified") echo "Diret√≥rio de destino n√£o especificado" ;;
            "usage_init") echo "Uso: specswift init <diret√≥rio> [--ios] [--no-git]" ;;
            # Install
            "installing_specswift") echo "Instalando SpecSwift" ;;
            "already_installed") echo "SpecSwift j√° instalado" ;;
            "use_force_or_update") echo "Use --force para sobrescrever ou 'specswift update' para atualizar" ;;
            "existing_makefile_kept") echo "Makefile existente mantido" ;;
            # Update
            "updating_specswift") echo "Atualizando SpecSwift" ;;
            "not_installed_in_project") echo "SpecSwift n√£o est√° instalado neste projeto" ;;
            "run_install_first") echo "Execute 'specswift install' primeiro" ;;
            "updated_to_version") echo "SpecSwift atualizado para" ;;
            # Copy functions
            "workflows_copied") echo "workflows copiados" ;;
            "rules_copied") echo "rules copiadas" ;;
            "templates_copied") echo "templates copiados" ;;
            "scripts_copied") echo "scripts copiados" ;;
            # Git
            "git_repo_exists") echo "Reposit√≥rio Git j√° existe" ;;
            "repo_initialized") echo "Reposit√≥rio inicializado" ;;
            "gitignore_created") echo ".gitignore criado" ;;
            # Summary
            "project_created") echo "Projeto Criado!" ;;
            "structure") echo "Estrutura" ;;
            "next_steps") echo "Pr√≥ximos passos" ;;
            "run_to_configure") echo "Execute para configurar documenta√ß√£o" ;;
            "run_to_create_feature") echo "Execute para criar uma feature" ;;
            "specswift_installed") echo "SpecSwift Instalado!" ;;
            "run_in_windsurf") echo "Execute no Windsurf para configurar documenta√ß√£o base" ;;
            "run_in_cursor") echo "Execute no Cursor para configurar documenta√ß√£o base" ;;
            "run_in_ide") echo "Execute no editor para configurar documenta√ß√£o base" ;;
            "to_create_new_feature") echo "para criar uma nova feature" ;;
            "select_editor") echo "Selecione o editor" ;;
            "editor_cursor") echo "Cursor" ;;
            "editor_windsurf") echo "Windsurf" ;;
            "invalid_editor") echo "Editor inv√°lido. Use 'cursor' ou 'windsurf'" ;;
            # Makefile
            "makefile_created") echo "Makefile criado" ;;
            "xcode_project_created") echo "Projeto Xcode criado" ;;
            "xcodegen_not_found") echo "xcodegen n√£o encontrado. Instale com: brew install xcodegen" ;;
            "generating_xcode_project") echo "Gerando projeto Xcode" ;;
            "template_not_found") echo "Template n√£o encontrado" ;;
            "available_templates") echo "Templates dispon√≠veis" ;;
            "xcode_project") echo "Projeto Xcode" ;;
            # Dependencies
            "checking_dependencies") echo "Verificando depend√™ncias" ;;
            "installing_homebrew") echo "Instalando Homebrew" ;;
            "homebrew_installed") echo "Homebrew instalado" ;;
            "homebrew_found") echo "Homebrew encontrado" ;;
            "installing_dependency") echo "Instalando" ;;
            "dependency_installed") echo "instalado com sucesso" ;;
            "dependency_found") echo "encontrado" ;;
            "dependency_install_failed") echo "Falha ao instalar" ;;
            "skip_dependency_install") echo "Pulando instala√ß√£o de depend√™ncias (use --no-deps para desativar)" ;;
            "all_dependencies_ok") echo "Todas as depend√™ncias est√£o instaladas" ;;
            "install_dependencies_prompt") echo "Deseja instalar as depend√™ncias faltantes?" ;;
            "yes_no") echo "[S/n]" ;;
            # Interactive menu
            "interactive_mode") echo "Modo Interativo" ;;
            "enter_project_directory") echo "Digite o diret√≥rio do projeto" ;;
            "select_language") echo "Selecione o idioma" ;;
            "language_english") echo "Ingl√™s (English)" ;;
            "language_portuguese") echo "Portugu√™s" ;;
            "enable_ios_mode") echo "Habilitar modo iOS/Swift?" ;;
            "select_xcode_template") echo "Selecione o template Xcode" ;;
            "template_none") echo "Nenhum (apenas estrutura SpecSwift)" ;;
            "template_swiftui_ios") echo "SwiftUI iOS" ;;
            "template_swiftui_macos") echo "SwiftUI macOS" ;;
            "enter_bundle_id_prefix") echo "Digite o prefixo do Bundle ID" ;;
            "bundle_id_default") echo "Padr√£o (example)" ;;
            "initialize_git") echo "Inicializar reposit√≥rio Git?" ;;
            "check_dependencies") echo "Verificar e instalar depend√™ncias?" ;;
            "verbose_mode") echo "Modo verbose (output detalhado)?" ;;
            "force_overwrite") echo "For√ßar sobrescrita de arquivos existentes?" ;;
            "preview_configuration") echo "Preview da Configura√ß√£o" ;;
            "confirm_create") echo "Confirmar cria√ß√£o?" ;;
            "confirm_install") echo "Confirmar instala√ß√£o?" ;;
            "cancelled") echo "Opera√ß√£o cancelada" ;;
            "invalid_choice") echo "Escolha inv√°lida" ;;
            "invalid_directory") echo "Diret√≥rio inv√°lido" ;;
            "yes") echo "Sim" ;;
            "no") echo "N√£o" ;;
            *) echo "$key" ;;
        esac
    else
        # English (default)
        case "$key" in
            # General
            "unknown_option") echo "Unknown option" ;;
            "unknown_command") echo "Unknown command" ;;
            "run_help") echo "Run 'specswift help' to see available commands" ;;
            # Help
            "usage") echo "USAGE" ;;
            "commands") echo "COMMANDS" ;;
            "cmd_init") echo "Create new project with complete SpecSwift structure" ;;
            "cmd_install") echo "Install SpecSwift in existing project (current directory)" ;;
            "cmd_update") echo "Update workflows and templates to latest version" ;;
            "cmd_doctor") echo "Check installation and dependencies" ;;
            "cmd_version") echo "Show version" ;;
            "cmd_help") echo "Show this help" ;;
            "global_options") echo "GLOBAL OPTIONS" ;;
            "opt_ios") echo "Apply iOS/Swift specific configurations" ;;
            "opt_no_git") echo "Don't initialize/modify Git repository" ;;
            "opt_force") echo "Overwrite existing files" ;;
            "opt_verbose") echo "Detailed output" ;;
            "opt_quiet") echo "Errors only" ;;
            "opt_lang") echo "Set language (en/pt)" ;;
            "opt_template") echo "Xcode project template (swiftui-ios, swiftui-macos)" ;;
            "examples") echo "EXAMPLES" ;;
            "example_create_ios") echo "# Create new iOS project" ;;
            "example_install_existing") echo "# Install in existing project" ;;
            "example_update") echo "# Update workflows" ;;
            "example_check") echo "# Check installation" ;;
            "recommended_flow") echo "RECOMMENDED FLOW" ;;
            "in_windsurf") echo "In Windsurf" ;;
            "documentation") echo "DOCUMENTATION" ;;
            "after_install_see") echo "After installation, see" ;;
            # Doctor
            "checking_installation") echo "Checking Installation" ;;
            "workflows") echo "Workflows" ;;
            "templates") echo "Templates" ;;
            "rules") echo "Rules" ;;
            "files") echo "files" ;;
            "tools") echo "Tools" ;;
            "not_found") echo "not found" ;;
            "optional") echo "optional" ;;
            "required_ios_only") echo "required for iOS only" ;;
            "optional_ios") echo "optional for iOS" ;;
            "installed") echo "installed" ;;
            "current_project") echo "Current Project" ;;
            "workflows_not_installed") echo "Workflows not installed in this project" ;;
            "templates_installed") echo "Templates installed" ;;
            "templates_not_installed") echo "Templates not installed" ;;
            "incomplete_install") echo "Incomplete installation. Run: specswift update" ;;
            "all_ok") echo "All OK!" ;;
            # Init
            "creating_new_project") echo "Creating New Project" ;;
            "directory") echo "Directory" ;;
            "target_dir_not_specified") echo "Target directory not specified" ;;
            "usage_init") echo "Usage: specswift init <directory> [--ios] [--no-git]" ;;
            # Install
            "installing_specswift") echo "Installing SpecSwift" ;;
            "already_installed") echo "SpecSwift already installed" ;;
            "use_force_or_update") echo "Use --force to overwrite or 'specswift update' to update" ;;
            "existing_makefile_kept") echo "Existing Makefile kept" ;;
            # Update
            "updating_specswift") echo "Updating SpecSwift" ;;
            "not_installed_in_project") echo "SpecSwift is not installed in this project" ;;
            "run_install_first") echo "Run 'specswift install' first" ;;
            "updated_to_version") echo "SpecSwift updated to" ;;
            # Copy functions
            "workflows_copied") echo "workflows copied" ;;
            "rules_copied") echo "rules copied" ;;
            "templates_copied") echo "templates copied" ;;
            "scripts_copied") echo "scripts copied" ;;
            # Git
            "git_repo_exists") echo "Git repository already exists" ;;
            "repo_initialized") echo "Repository initialized" ;;
            "gitignore_created") echo ".gitignore created" ;;
            # Summary
            "project_created") echo "Project Created!" ;;
            "structure") echo "Structure" ;;
            "next_steps") echo "Next steps" ;;
            "run_to_configure") echo "Run to configure documentation" ;;
            "run_to_create_feature") echo "Run to create a feature" ;;
            "specswift_installed") echo "SpecSwift Installed!" ;;
            "run_in_windsurf") echo "Run in Windsurf to configure base documentation" ;;
            "run_in_cursor") echo "Run in Cursor to configure base documentation" ;;
            "run_in_ide") echo "Run in editor to configure base documentation" ;;
            "to_create_new_feature") echo "to create a new feature" ;;
            "select_editor") echo "Select editor" ;;
            "editor_cursor") echo "Cursor" ;;
            "editor_windsurf") echo "Windsurf" ;;
            "invalid_editor") echo "Invalid editor. Use 'cursor' or 'windsurf'" ;;
            # Makefile
            "makefile_created") echo "Makefile created" ;;
            "xcode_project_created") echo "Xcode project created" ;;
            "xcodegen_not_found") echo "xcodegen not found. Install with: brew install xcodegen" ;;
            "generating_xcode_project") echo "Generating Xcode project" ;;
            "template_not_found") echo "Template not found" ;;
            "available_templates") echo "Available templates" ;;
            "xcode_project") echo "Xcode Project" ;;
            # Dependencies
            "checking_dependencies") echo "Checking dependencies" ;;
            "installing_homebrew") echo "Installing Homebrew" ;;
            "homebrew_installed") echo "Homebrew installed" ;;
            "homebrew_found") echo "Homebrew found" ;;
            "installing_dependency") echo "Installing" ;;
            "dependency_installed") echo "installed successfully" ;;
            "dependency_found") echo "found" ;;
            "dependency_install_failed") echo "Failed to install" ;;
            "skip_dependency_install") echo "Skipping dependency installation (use --no-deps to disable)" ;;
            "all_dependencies_ok") echo "All dependencies are installed" ;;
            "install_dependencies_prompt") echo "Do you want to install missing dependencies?" ;;
            "yes_no") echo "[Y/n]" ;;
            # Interactive menu
            "interactive_mode") echo "Interactive Mode" ;;
            "enter_project_directory") echo "Enter project directory" ;;
            "select_language") echo "Select language" ;;
            "language_english") echo "English" ;;
            "language_portuguese") echo "Portuguese" ;;
            "enable_ios_mode") echo "Enable iOS/Swift mode?" ;;
            "select_xcode_template") echo "Select Xcode template" ;;
            "template_none") echo "None (SpecSwift structure only)" ;;
            "template_swiftui_ios") echo "SwiftUI iOS" ;;
            "template_swiftui_macos") echo "SwiftUI macOS" ;;
            "enter_bundle_id_prefix") echo "Enter Bundle ID prefix" ;;
            "bundle_id_default") echo "Default (example)" ;;
            "initialize_git") echo "Initialize Git repository?" ;;
            "check_dependencies") echo "Check and install dependencies?" ;;
            "verbose_mode") echo "Verbose mode (detailed output)?" ;;
            "force_overwrite") echo "Force overwrite existing files?" ;;
            "preview_configuration") echo "Configuration Preview" ;;
            "confirm_create") echo "Confirm creation?" ;;
            "confirm_install") echo "Confirm installation?" ;;
            "cancelled") echo "Operation cancelled" ;;
            "invalid_choice") echo "Invalid choice" ;;
            "invalid_directory") echo "Invalid directory" ;;
            "yes") echo "Yes" ;;
            "no") echo "No" ;;
            *) echo "$key" ;;
        esac
    fi
}

# =============================================================================
# Cores
# =============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# =============================================================================
# Fun√ß√µes de output
# =============================================================================
print_header() { echo -e "\n${BOLD}${BLUE}$1${NC}"; }
print_success() { echo -e "${GREEN}‚úì${NC} $1"; }
print_warning() { echo -e "${YELLOW}‚ö†${NC} $1"; }
print_error() { echo -e "${RED}‚úó${NC} $1" >&2; }
print_info() { echo -e "${CYAN}‚Üí${NC} $1"; }
print_dim() { echo -e "${DIM}$1${NC}"; }

# =============================================================================
# Dependency Management
# =============================================================================
_install_homebrew() {
    print_info "$(L "installing_homebrew")..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH for Apple Silicon Macs
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f "/usr/local/bin/brew" ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
    
    if command -v brew &> /dev/null; then
        print_success "$(L "homebrew_installed")"
        return 0
    else
        print_error "$(L "dependency_install_failed") Homebrew"
        return 1
    fi
}

_install_brew_package() {
    local package="$1"
    local package_name="${2:-$package}"
    
    print_info "$(L "installing_dependency") $package_name..."
    if brew install "$package" 2>/dev/null; then
        print_success "$package_name $(L "dependency_installed")"
        return 0
    else
        print_error "$(L "dependency_install_failed") $package_name"
        return 1
    fi
}

_check_and_install_dependencies() {
    local ios_mode="${1:-false}"
    local xcode_template="${2:-}"
    local auto_install="${3:-true}"
    local verbose="${4:-false}"
    
    print_header "üîß $(L "checking_dependencies")"
    
    local missing_deps=()
    local has_homebrew=false
    
    # Check Homebrew
    if command -v brew &> /dev/null; then
        print_success "Homebrew $(L "dependency_found")"
        has_homebrew=true
    else
        print_warning "Homebrew $(L "not_found")"
        missing_deps+=("homebrew")
    fi
    
    # Check Git
    if command -v git &> /dev/null; then
        [[ "$verbose" == true ]] && print_success "Git $(L "dependency_found")"
    else
        print_warning "Git $(L "not_found")"
        missing_deps+=("git")
    fi
    
    # Check xcodegen (required if using --template)
    if [[ -n "$xcode_template" ]]; then
        if command -v xcodegen &> /dev/null; then
            print_success "xcodegen $(L "dependency_found")"
        else
            print_warning "xcodegen $(L "not_found")"
            missing_deps+=("xcodegen")
        fi
    fi
    
    # Check xcbeautify (optional but recommended for iOS)
    if [[ "$ios_mode" == true ]]; then
        if command -v xcbeautify &> /dev/null; then
            [[ "$verbose" == true ]] && print_success "xcbeautify $(L "dependency_found")"
        else
            [[ "$verbose" == true ]] && print_dim "  xcbeautify $(L "not_found") ($(L "optional"))"
            # Don't add to missing_deps as it's optional
        fi
    fi
    
    # If no missing dependencies, we're done
    if [[ ${#missing_deps[@]} -eq 0 ]]; then
        print_success "$(L "all_dependencies_ok")"
        return 0
    fi
    
    # If auto_install is false, just warn and continue
    if [[ "$auto_install" != true ]]; then
        return 0
    fi
    
    # Ask user for permission to install
    echo ""
    echo -e "${YELLOW}$(L "install_dependencies_prompt")${NC} $(L "yes_no")"
    if ! read -r response; then
        # EOF detected - skip installation
        print_info "$(L "skip_dependency_install")"
        return 0
    fi
    
    # Default to yes for English, sim for Portuguese
    if [[ "$LANG_CODE" == "pt" ]]; then
        if [[ "$response" =~ ^[Nn]$ ]]; then
            print_info "$(L "skip_dependency_install")"
            return 0
        fi
    else
        if [[ "$response" =~ ^[Nn]$ ]]; then
            print_info "$(L "skip_dependency_install")"
            return 0
        fi
    fi
    
    # Install Homebrew first if missing
    if [[ " ${missing_deps[*]} " =~ " homebrew " ]]; then
        if ! _install_homebrew; then
            print_error "Cannot continue without Homebrew"
            return 1
        fi
        has_homebrew=true
        # Remove homebrew from missing_deps
        missing_deps=("${missing_deps[@]/homebrew}")
    fi
    
    # Install remaining dependencies via Homebrew
    for dep in "${missing_deps[@]}"; do
        if [[ -n "$dep" && "$has_homebrew" == true ]]; then
            _install_brew_package "$dep"
        fi
    done
    
    echo ""
    return 0
}

# =============================================================================
# Banner
# =============================================================================
show_banner() {
    echo -e "${BOLD}${BLUE}"
    cat << 'BANNER'
   ____                  ____          _  __ _   
  / ___| _ __   ___  ___/ ___|_      _(_)/ _| |_ 
  \___ \| '_ \ / _ \/ __\___ \ \ /\ / / | |_| __|
   ___) | |_) |  __/ (__ ___) \ V  V /| |  _| |_ 
  |____/| .__/ \___|\___|____/ \_/\_/ |_|_|  \__|
        |_|                                      
BANNER
    echo -e "${NC}"
    echo -e "${DIM}  Version $VERSION - Feature Specification Toolkit${NC}"
    echo ""
}

# =============================================================================
# Help
# =============================================================================
show_help() {
    show_banner
    cat << EOF
$(L "usage"):
    specswift <command> [options]

$(L "commands"):
    init <directory>     $(L "cmd_init")
    install              $(L "cmd_install")
    update               $(L "cmd_update")
    doctor               $(L "cmd_doctor")
    version              $(L "cmd_version")
    help                 $(L "cmd_help")

$(L "global_options"):
    --ios                $(L "opt_ios")
    --template <name>    $(L "opt_template")
    --bundle-id <prefix> Bundle ID prefix (default: example)
    --editor <cursor|windsurf> Select IDE editor (default: prompt)
    --no-git             $(L "opt_no_git")
    --no-deps            Skip dependency check/installation
    --force              $(L "opt_force")
    --lang <en|pt>       $(L "opt_lang")
    -v, --verbose        $(L "opt_verbose")
    -q, --quiet          $(L "opt_quiet")

$(L "examples"):
    $(L "example_create_ios")
    specswift init ~/Projects/my-app --ios

    # Create iOS project with Xcode project
    specswift init ~/Projects/my-app --template swiftui-ios --bundle-id mycompany

    # Create macOS project with Xcode project
    specswift init ~/Projects/my-mac-app --template swiftui-macos

    $(L "example_install_existing")
    cd ~/Projects/existing-project
    specswift install --ios

    $(L "example_update")
    specswift update

    $(L "example_check")
    specswift doctor

$(L "recommended_flow"):
    1. specswift init ~/new-project --ios
    2. cd ~/new-project && (cursor . or windsurf .)
    3. In editor: /specswift.constitution
    4. In editor: /specswift.create-prd "feature description"

$(L "documentation"):
    $(L "after_install_see"): _docs/SPECSWIFT-WORKFLOWS.md

EOF
}

# =============================================================================
# Version
# =============================================================================
show_version() {
    echo "SpecSwift CLI v$VERSION"
}

# =============================================================================
# Doctor - Check installation
# =============================================================================
cmd_doctor() {
    show_banner
    print_header "üîç $(L "checking_installation")"

    local has_errors=false

    # Check SpecSwift structure
    echo ""
    echo -e "${BOLD}SpecSwift CLI:${NC}"
    
    if [[ -d "$LIB_DIR/workflows" ]]; then
        local wf_count=$(ls -1 "$LIB_DIR/workflows"/*.md 2>/dev/null | wc -l | tr -d ' ')
        print_success "$(L "workflows"): $wf_count $(L "files")"
    else
        print_error "$(L "workflows") $(L "not_found")"
        has_errors=true
    fi

    if [[ -d "$LIB_DIR/templates" ]]; then
        local tpl_count=$(ls -1 "$LIB_DIR/templates"/*.md 2>/dev/null | wc -l | tr -d ' ')
        print_success "$(L "templates"): $tpl_count $(L "files")"
    else
        print_error "$(L "templates") $(L "not_found")"
        has_errors=true
    fi

    if [[ -d "$LIB_DIR/rules" ]]; then
        local rules_count=$(ls -1 "$LIB_DIR/rules"/*.md 2>/dev/null | wc -l | tr -d ' ')
        print_success "$(L "rules"): $rules_count $(L "files")"
    else
        print_error "$(L "rules") $(L "not_found")"
        has_errors=true
    fi

    # Check external tools
    echo ""
    echo -e "${BOLD}$(L "tools"):${NC}"
    
    if command -v git &> /dev/null; then
        print_success "Git: $(git --version | head -1)"
    else
        print_warning "Git $(L "not_found") ($(L "optional"))"
    fi

    if command -v xcodebuild &> /dev/null; then
        print_success "Xcode: $(xcodebuild -version | head -1)"
    else
        print_dim "  Xcode $(L "not_found") ($(L "required_ios_only"))"
    fi

    if command -v xcbeautify &> /dev/null; then
        print_success "xcbeautify: $(L "installed")"
    else
        print_dim "  xcbeautify $(L "not_found") ($(L "optional_ios"))"
    fi

    if command -v xcodegen &> /dev/null; then
        print_success "xcodegen: $(xcodegen --version 2>/dev/null || echo "$(L "installed")")"
    else
        print_dim "  xcodegen $(L "not_found") ($(L "optional") - brew install xcodegen)"
    fi

    # Check current project (if in one)
    if [[ -d ".cursor" ]] || [[ -d ".windsurf" ]]; then
        echo ""
        echo -e "${BOLD}$(L "current_project"):${NC}"
        
        if [[ -d ".cursor/workflows" ]]; then
            local proj_wf=$(ls -1 .cursor/workflows/specswift.*.md 2>/dev/null | wc -l | tr -d ' ')
            print_success "SpecSwift workflows (Cursor): $proj_wf"
        fi
        
        if [[ -d ".windsurf/workflows" ]]; then
            local proj_wf=$(ls -1 .windsurf/workflows/specswift.*.md 2>/dev/null | wc -l | tr -d ' ')
            print_success "SpecSwift workflows (Windsurf): $proj_wf"
        fi
        
        if [[ ! -d ".cursor/workflows" ]] && [[ ! -d ".windsurf/workflows" ]]; then
            print_warning "$(L "workflows_not_installed")"
        fi

        if [[ -d "_docs/templates" ]]; then
            print_success "$(L "templates_installed")"
        else
            print_warning "$(L "templates_not_installed")"
        fi
    fi

    echo ""
    if [[ "$has_errors" == true ]]; then
        print_error "$(L "incomplete_install")"
        return 1
    else
        print_success "$(L "all_ok")"
    fi
}

# =============================================================================
# Init - Create new project
# =============================================================================
cmd_init() {
    local target_dir=""
    local ios_mode=false
    local init_git=true
    local force=false
    local verbose=false
    local xcode_template=""
    local bundle_prefix=""
    local check_deps=true
    local editor=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --ios) ios_mode=true; shift ;;
            --no-git) init_git=false; shift ;;
            --no-deps) check_deps=false; shift ;;
            --force) force=true; shift ;;
            -v|--verbose) verbose=true; shift ;;
            --editor)
                if [[ -n "$2" && ! "$2" =~ ^- ]]; then
                    if [[ "$2" =~ ^(cursor|windsurf)$ ]]; then
                        editor="$2"
                        shift 2
                    else
                        print_error "$(L "invalid_editor")"
                        exit 1
                    fi
                else
                    print_error "Editor required. Use 'cursor' or 'windsurf'"
                    exit 1
                fi
                ;;
            --template)
                if [[ -n "$2" && ! "$2" =~ ^- ]]; then
                    xcode_template="$2"
                    ios_mode=true  # Automatically enable iOS mode when using template
                    shift 2
                else
                    print_error "$(L "template_not_found")"
                    echo "$(L "available_templates"): swiftui-ios, swiftui-macos"
                    exit 1
                fi
                ;;
            --bundle-id)
                if [[ -n "$2" && ! "$2" =~ ^- ]]; then
                    bundle_prefix="$2"
                    shift 2
                else
                    print_error "Bundle ID prefix required"
                    exit 1
                fi
                ;;
            -*)
                print_error "$(L "unknown_option"): $1"
                exit 1
                ;;
            *)
                if [[ -z "$target_dir" ]]; then
                    target_dir="$1"
                fi
                shift
                ;;
        esac
    done

    # Check if interactive mode should be activated
    # Interactive mode if: no target_dir AND no CLI options provided (except --lang which is global)
    # If target_dir is provided, use CLI mode even without other options
    if [[ -z "$target_dir" ]]; then
        local has_cli_options=false
        if [[ "$ios_mode" == true ]] || [[ "$init_git" == false ]] || [[ "$force" == true ]] || \
           [[ "$verbose" == true ]] || [[ "$check_deps" == false ]] || [[ -n "$editor" ]] || \
           [[ -n "$xcode_template" ]] || [[ -n "$bundle_prefix" ]]; then
            has_cli_options=true
        fi
        
        if [[ "$has_cli_options" == false ]]; then
            # Interactive mode - no arguments provided
            _interactive_menu_init
            return 0
        else
            # CLI options provided but no directory - error
            print_error "$(L "target_dir_not_specified")"
            echo "$(L "usage_init")"
            exit 1
        fi
    fi

    # Call internal function with parsed arguments
    cmd_init_internal "$target_dir" "$editor" "$ios_mode" "$init_git" "$check_deps" "$verbose" "$force" "$xcode_template" "$bundle_prefix"
}

cmd_init_internal() {
    local target_dir="$1"
    local editor="${2:-}"
    local ios_mode="${3:-false}"
    local init_git="${4:-true}"
    local check_deps="${5:-true}"
    local verbose="${6:-false}"
    local force="${7:-false}"
    local xcode_template="${8:-}"
    local bundle_prefix="${9:-}"

    show_banner
    
    # Check and install dependencies
    if [[ "$check_deps" == true ]]; then
        _check_and_install_dependencies "$ios_mode" "$xcode_template" true "$verbose"
    fi
    
    print_header "üì¶ $(L "creating_new_project")"

    # Create directory
    mkdir -p "$target_dir"
    target_dir="$(cd "$target_dir" && pwd)"
    print_success "$(L "directory"): $target_dir"

    # Extract project name from directory
    local project_name=$(basename "$target_dir")
    
    # Default bundle prefix if not provided
    if [[ -z "$bundle_prefix" ]]; then
        bundle_prefix="example"
    fi

    # Create Xcode project if template specified
    if [[ -n "$xcode_template" ]]; then
        _create_xcode_project "$target_dir" "$xcode_template" "$project_name" "$bundle_prefix" "$verbose"
    fi

    # Prompt for editor if not specified
    if [[ -z "$editor" ]]; then
        if ! editor=$(_prompt_editor); then
            print_info "$(L "cancelled")"
            exit 0
        fi
    fi

    # Copiar estrutura
    _copy_workflows "$target_dir" "$editor" "$verbose"
    _copy_rules "$target_dir" "$editor" "$ios_mode" "$verbose"
    _copy_templates "$target_dir" "$verbose"
    _copy_scripts "$target_dir" "$verbose"
    _copy_documentation "$target_dir" "$ios_mode" "$verbose"
    _create_makefile "$target_dir" "$ios_mode" "$project_name" "$xcode_template"

    # Git
    if [[ "$init_git" == true ]]; then
        _init_git "$target_dir"
    fi

    # Summary
    _print_init_summary "$target_dir" "$ios_mode" "$xcode_template" "$project_name" "$editor"
}

# =============================================================================
# Install - Install in existing project
# =============================================================================
cmd_install() {
    local target_dir="$(pwd)"
    local ios_mode=false
    local force=false
    local verbose=false
    local check_deps=true
    local editor=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --ios) ios_mode=true; shift ;;
            --force) force=true; shift ;;
            --no-deps) check_deps=false; shift ;;
            -v|--verbose) verbose=true; shift ;;
            --editor)
                if [[ -n "$2" && ! "$2" =~ ^- ]]; then
                    if [[ "$2" =~ ^(cursor|windsurf)$ ]]; then
                        editor="$2"
                        shift 2
                    else
                        print_error "$(L "invalid_editor")"
                        exit 1
                    fi
                else
                    print_error "Editor required. Use 'cursor' or 'windsurf'"
                    exit 1
                fi
                ;;
            -*)
                print_error "$(L "unknown_option"): $1"
                exit 1
                ;;
            *) shift ;;
        esac
    done

    # Check if interactive mode should be activated
    # Interactive mode if: no CLI options provided (except --lang which is global)
    local has_cli_options=false
    if [[ "$ios_mode" == true ]] || [[ "$force" == true ]] || \
       [[ "$verbose" == true ]] || [[ "$check_deps" == false ]] || [[ -n "$editor" ]]; then
        has_cli_options=true
    fi
    
    if [[ "$has_cli_options" == false ]]; then
        # Interactive mode - no arguments provided
        _interactive_menu_install
        return 0
    fi

    # Call internal function with parsed arguments
    cmd_install_internal "$editor" "$ios_mode" "$check_deps" "$verbose" "$force"
}

cmd_install_internal() {
    local editor="${1:-}"
    local ios_mode="${2:-false}"
    local check_deps="${3:-true}"
    local verbose="${4:-false}"
    local force="${5:-false}"
    local target_dir="$(pwd)"

    show_banner
    
    # Check and install dependencies
    if [[ "$check_deps" == true ]]; then
        _check_and_install_dependencies "$ios_mode" "" true "$verbose"
    fi
    
    print_header "üì• $(L "installing_specswift")"
    print_info "$(L "directory"): $target_dir"

    # Prompt for editor if not specified
    if [[ -z "$editor" ]]; then
        if ! editor=$(_prompt_editor); then
            print_info "$(L "cancelled")"
            exit 0
        fi
    fi

    # Determine editor directory
    local editor_dir=""
    case "$editor" in
        cursor)
            editor_dir=".cursor"
            ;;
        windsurf)
            editor_dir=".windsurf"
            ;;
    esac

    # Check if already exists
    if [[ -d "$target_dir/$editor_dir/workflows" && "$force" != true ]]; then
        local existing=$(ls -1 "$target_dir/$editor_dir/workflows"/specswift.*.md 2>/dev/null | wc -l | tr -d ' ')
        if [[ "$existing" -gt 0 ]]; then
            print_warning "$(L "already_installed") ($existing workflows)"
            echo ""
            echo "$(L "use_force_or_update")"
            exit 1
        fi
    fi

    # Copy structure (without overwriting project files)
    _copy_workflows "$target_dir" "$editor" "$verbose"
    _copy_rules "$target_dir" "$editor" "$ios_mode" "$verbose"
    _copy_templates "$target_dir" "$verbose"
    _copy_scripts "$target_dir" "$verbose"
    _copy_documentation "$target_dir" "$ios_mode" "$verbose"

    # Don't create Makefile if it already exists
    if [[ ! -f "$target_dir/Makefile" ]]; then
        _create_makefile "$target_dir" "$ios_mode"
    else
        print_info "$(L "existing_makefile_kept")"
    fi

    # Summary
    _print_install_summary "$target_dir" "$editor"
}

# =============================================================================
# Update - Update workflows and templates
# =============================================================================
cmd_update() {
    local target_dir="$(pwd)"
    local verbose=false
    local editor=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -v|--verbose) verbose=true; shift ;;
            --editor)
                if [[ -n "$2" && ! "$2" =~ ^- ]]; then
                    if [[ "$2" =~ ^(cursor|windsurf)$ ]]; then
                        editor="$2"
                        shift 2
                    else
                        print_error "$(L "invalid_editor")"
                        exit 1
                    fi
                else
                    print_error "Editor required. Use 'cursor' or 'windsurf'"
                    exit 1
                fi
                ;;
            *) shift ;;
        esac
    done

    show_banner
    print_header "üîÑ $(L "updating_specswift")"

    # Detect which editor is installed
    if [[ -z "$editor" ]]; then
        if [[ -d "$target_dir/.cursor" ]]; then
            editor="cursor"
        elif [[ -d "$target_dir/.windsurf" ]]; then
            editor="windsurf"
        else
            print_error "$(L "not_installed_in_project")"
            echo "$(L "run_install_first")"
            exit 1
        fi
    fi

    # Determine editor directory
    local editor_dir=""
    case "$editor" in
        cursor)
            editor_dir=".cursor"
            ;;
        windsurf)
            editor_dir=".windsurf"
            ;;
    esac

    if [[ ! -d "$target_dir/$editor_dir" ]]; then
        print_error "$(L "not_installed_in_project")"
        echo "$(L "run_install_first")"
        exit 1
    fi

    # Update workflows (always overwrite)
    _copy_workflows "$target_dir" "$editor" "$verbose" true

    # Update templates
    _copy_templates "$target_dir" "$verbose" true

    # Update documentation
    if [[ -f "$LIB_DIR/../docs/SPECSWIFT-WORKFLOWS.md" ]]; then
        cp "$LIB_DIR/../docs/SPECSWIFT-WORKFLOWS.md" "$target_dir/_docs/" 2>/dev/null || true
    fi

    echo ""
    print_success "$(L "updated_to_version") v$VERSION"
}

# =============================================================================
# Helper functions
# =============================================================================
_prompt_editor() {
    local editor=""
    local choice=""
    
    echo "" >&2
    echo -e "${YELLOW}$(L "select_editor"):${NC}" >&2
    echo "  1) $(L "editor_cursor")" >&2
    echo "  2) $(L "editor_windsurf")" >&2
    echo "" >&2
    if [[ "$LANG_CODE" == "pt" ]]; then
        echo -n "Escolha [1-2]: " >&2
    else
        echo -n "Choose [1-2]: " >&2
    fi
    if ! read -r choice; then
        # EOF detected
        print_error "$(L "cancelled")" >&2
        return 1
    fi
    
    case "$choice" in
        1|cursor|Cursor|CURSOR)
            editor="cursor"
            ;;
        2|windsurf|Windsurf|WINDSURF)
            editor="windsurf"
            ;;
        *)
            print_error "$(L "invalid_editor")" >&2
            return 1
            ;;
    esac
    
    echo "$editor"
}

# =============================================================================
# Interactive Menu Helper Functions
# =============================================================================
_prompt_yes_no() {
    local prompt="$1"
    local default="${2:-yes}"
    local response=""
    
    while true; do
        if [[ "$LANG_CODE" == "pt" ]]; then
            if [[ "$default" == "yes" ]]; then
                echo -e "${YELLOW}$prompt${NC} $(L "yes_no")" >&2
            else
                echo -e "${YELLOW}$prompt${NC} [s/N]" >&2
            fi
        else
            if [[ "$default" == "yes" ]]; then
                echo -e "${YELLOW}$prompt${NC} $(L "yes_no")" >&2
            else
                echo -e "${YELLOW}$prompt${NC} [y/N]" >&2
            fi
        fi
        if ! read -r response; then
            # EOF detected - exit loop
            print_error "$(L "cancelled")" >&2
            return 1
        fi
        
        # Use default if empty
        if [[ -z "$response" ]]; then
            response="$default"
        fi
        
        case "$response" in
            [YySs]*|[Yy][Ee][Ss]|[Ss][Ii][Mm])
                echo "yes"
                return 0
                ;;
            [Nn]*|[Nn][Oo])
                echo "no"
                return 0
                ;;
            *)
                print_error "$(L "invalid_choice")" >&2
                ;;
        esac
    done
}

_prompt_select() {
    local prompt="$1"
    shift
    local options=("$@")
    local choice=""
    local max="${#options[@]}"
    
    echo "" >&2
    echo -e "${YELLOW}$prompt${NC}" >&2
    for i in "${!options[@]}"; do
        echo "  $((i+1))) ${options[$i]}" >&2
    done
    echo "" >&2
    
    while true; do
        if [[ "$LANG_CODE" == "pt" ]]; then
            echo -n "Escolha [1-$max]: " >&2
        else
            echo -n "Choose [1-$max]: " >&2
        fi
        if ! read -r choice; then
            # EOF detected - exit loop
            print_error "$(L "cancelled")" >&2
            return 1
        fi
        
        if [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le "$max" ]]; then
            echo "$((choice-1))"
            return 0
        else
            print_error "$(L "invalid_choice")" >&2
        fi
    done
}

_prompt_text() {
    local prompt="$1"
    local default="${2:-}"
    local validate="${3:-}"
    local response=""
    
    while true; do
        if [[ -n "$default" ]]; then
            if [[ "$LANG_CODE" == "pt" ]]; then
                echo -e "${YELLOW}$prompt${NC} [padr√£o: $default]: " >&2
            else
                echo -e "${YELLOW}$prompt${NC} [default: $default]: " >&2
            fi
        else
            echo -e "${YELLOW}$prompt${NC}: " >&2
        fi
        if ! read -r response; then
            # EOF detected - exit loop
            print_error "$(L "cancelled")" >&2
            return 1
        fi
        
        # Use default if empty
        if [[ -z "$response" && -n "$default" ]]; then
            response="$default"
        fi
        
        # Validate if validator function provided
        if [[ -n "$validate" ]]; then
            if $validate "$response"; then
                echo "$response"
                return 0
            else
                print_error "$(L "invalid_directory")" >&2
                continue
            fi
        elif [[ -n "$response" ]]; then
            echo "$response"
            return 0
        elif [[ -z "$response" && -z "$default" ]]; then
            print_error "$(L "invalid_choice")" >&2
        else
            echo "$response"
            return 0
        fi
    done
}

_validate_directory() {
    local dir="$1"
    # Basic validation - check if parent directory exists
    local parent=$(dirname "$dir")
    if [[ -d "$parent" ]] || [[ "$parent" == "." ]] || [[ "$parent" == "/" ]]; then
        return 0
    fi
    return 1
}

# =============================================================================
# Interactive Menu Functions
# =============================================================================
_interactive_menu_init() {
    show_banner
    print_header "üéØ $(L "interactive_mode") - $(L "creating_new_project")"
    echo ""
    
    # 1. Project directory
    local target_dir=""
    if ! target_dir=$(_prompt_text "$(L "enter_project_directory")" "$(pwd)/my-app" "_validate_directory"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    target_dir=$(eval echo "$target_dir")  # Expand ~ and variables
    
    # 2. Editor
    local editor=""
    if ! editor=$(_prompt_editor); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # 3. Language
    local lang_choice=""
    if ! lang_choice=$(_prompt_select "$(L "select_language")" "$(L "language_english")" "$(L "language_portuguese")"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    if [[ "$lang_choice" == "0" ]]; then
        LANG_CODE="en"
    else
        LANG_CODE="pt"
    fi
    
    # 4. iOS mode
    local ios_mode=""
    if ! ios_mode=$(_prompt_yes_no "$(L "enable_ios_mode")" "yes"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # 5. Xcode template (if iOS)
    local xcode_template=""
    local bundle_prefix=""
    if [[ "$ios_mode" == "yes" ]]; then
        local template_choice=""
        if ! template_choice=$(_prompt_select "$(L "select_xcode_template")" \
            "$(L "template_none")" \
            "$(L "template_swiftui_ios")" \
            "$(L "template_swiftui_macos")"); then
            print_info "$(L "cancelled")"
            exit 0
        fi
        
        case "$template_choice" in
            0) xcode_template="" ;;
            1) xcode_template="swiftui-ios" ;;
            2) xcode_template="swiftui-macos" ;;
        esac
        
        # 6. Bundle ID prefix (if template selected)
        if [[ -n "$xcode_template" ]]; then
            if ! bundle_prefix=$(_prompt_text "$(L "enter_bundle_id_prefix")" "example"); then
                print_info "$(L "cancelled")"
                exit 0
            fi
        fi
    fi
    
    # 7. Initialize Git
    local init_git=""
    if ! init_git=$(_prompt_yes_no "$(L "initialize_git")" "yes"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # 8. Check dependencies
    local check_deps=""
    if ! check_deps=$(_prompt_yes_no "$(L "check_dependencies")" "yes"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # 9. Verbose mode
    local verbose=""
    if ! verbose=$(_prompt_yes_no "$(L "verbose_mode")" "no"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # 10. Force overwrite
    local force=""
    if ! force=$(_prompt_yes_no "$(L "force_overwrite")" "no"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # Preview configuration
    echo ""
    print_header "üìã $(L "preview_configuration")"
    echo -e "  $(L "directory"): ${CYAN}$target_dir${NC}"
    echo -e "  $(L "select_editor"): ${CYAN}$editor${NC}"
    echo -e "  $(L "select_language"): ${CYAN}$LANG_CODE${NC}"
    echo -e "  $(L "enable_ios_mode"): ${CYAN}$ios_mode${NC}"
    if [[ "$ios_mode" == "yes" ]]; then
        if [[ -n "$xcode_template" ]]; then
            echo -e "  $(L "select_xcode_template"): ${CYAN}$xcode_template${NC}"
            if [[ -n "$bundle_prefix" ]]; then
                echo -e "  $(L "enter_bundle_id_prefix"): ${CYAN}$bundle_prefix${NC}"
            fi
        else
            echo -e "  $(L "select_xcode_template"): ${CYAN}$(L "template_none")${NC}"
        fi
    fi
    echo -e "  $(L "initialize_git"): ${CYAN}$init_git${NC}"
    echo -e "  $(L "check_dependencies"): ${CYAN}$check_deps${NC}"
    echo -e "  $(L "verbose_mode"): ${CYAN}$verbose${NC}"
    echo -e "  $(L "force_overwrite"): ${CYAN}$force${NC}"
    echo ""
    
    # Confirm
    local confirm=""
    if ! confirm=$(_prompt_yes_no "$(L "confirm_create")" "yes"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    if [[ "$confirm" != "yes" ]]; then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # Convert yes/no to boolean
    [[ "$ios_mode" == "yes" ]] && ios_mode=true || ios_mode=false
    [[ "$init_git" == "yes" ]] && init_git=true || init_git=false
    [[ "$check_deps" == "yes" ]] && check_deps=true || check_deps=false
    [[ "$verbose" == "yes" ]] && verbose=true || verbose=false
    [[ "$force" == "yes" ]] && force=true || force=false
    
    # Call cmd_init with collected options
    cmd_init_internal "$target_dir" "$editor" "$ios_mode" "$init_git" "$check_deps" "$verbose" "$force" "$xcode_template" "$bundle_prefix"
}

_interactive_menu_install() {
    show_banner
    print_header "üéØ $(L "interactive_mode") - $(L "installing_specswift")"
    echo ""
    
    # 1. Editor
    local editor=""
    if ! editor=$(_prompt_editor); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # 2. Language
    local lang_choice=""
    if ! lang_choice=$(_prompt_select "$(L "select_language")" "$(L "language_english")" "$(L "language_portuguese")"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    if [[ "$lang_choice" == "0" ]]; then
        LANG_CODE="en"
    else
        LANG_CODE="pt"
    fi
    
    # 3. iOS mode
    local ios_mode=""
    if ! ios_mode=$(_prompt_yes_no "$(L "enable_ios_mode")" "no"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # 4. Check dependencies
    local check_deps=""
    if ! check_deps=$(_prompt_yes_no "$(L "check_dependencies")" "yes"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # 5. Verbose mode
    local verbose=""
    if ! verbose=$(_prompt_yes_no "$(L "verbose_mode")" "no"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # 6. Force overwrite
    local force=""
    if ! force=$(_prompt_yes_no "$(L "force_overwrite")" "no"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # Preview configuration
    echo ""
    print_header "üìã $(L "preview_configuration")"
    echo -e "  $(L "select_editor"): ${CYAN}$editor${NC}"
    echo -e "  $(L "select_language"): ${CYAN}$LANG_CODE${NC}"
    echo -e "  $(L "enable_ios_mode"): ${CYAN}$ios_mode${NC}"
    echo -e "  $(L "check_dependencies"): ${CYAN}$check_deps${NC}"
    echo -e "  $(L "verbose_mode"): ${CYAN}$verbose${NC}"
    echo -e "  $(L "force_overwrite"): ${CYAN}$force${NC}"
    echo ""
    
    # Confirm
    local confirm=""
    if ! confirm=$(_prompt_yes_no "$(L "confirm_install")" "yes"); then
        print_info "$(L "cancelled")"
        exit 0
    fi
    if [[ "$confirm" != "yes" ]]; then
        print_info "$(L "cancelled")"
        exit 0
    fi
    
    # Convert yes/no to boolean
    [[ "$ios_mode" == "yes" ]] && ios_mode=true || ios_mode=false
    [[ "$check_deps" == "yes" ]] && check_deps=true || check_deps=false
    [[ "$verbose" == "yes" ]] && verbose=true || verbose=false
    [[ "$force" == "yes" ]] && force=true || force=false
    
    # Call cmd_install with collected options
    cmd_install_internal "$editor" "$ios_mode" "$check_deps" "$verbose" "$force"
}

# =============================================================================
# Helper copy functions
# =============================================================================
_copy_workflows() {
    local target="$1"
    local editor="$2"
    local verbose="${3:-false}"
    local overwrite="${4:-false}"

    print_header "üìã $(L "workflows")"
    
    # Determine directory based on editor
    local editor_dir=""
    case "$editor" in
        cursor)
            editor_dir=".cursor"
            ;;
        windsurf)
            editor_dir=".windsurf"
            ;;
        *)
            print_error "$(L "invalid_editor")"
            return 1
            ;;
    esac
    
    mkdir -p "$target/$editor_dir/workflows"

    # Use workflows from the selected language folder
    local wf_src="$LIB_DIR/workflows/$LANG_CODE"
    # Fallback to English if the specific language folder doesn't exist
    if [[ ! -d "$wf_src" ]]; then
        wf_src="$LIB_DIR/workflows/en"
    fi

    local count=0
    if [[ -d "$wf_src" ]]; then
        for file in "$wf_src"/*.md; do
            if [[ -f "$file" ]]; then
                local basename=$(basename "$file")
                if [[ "$overwrite" == true || ! -f "$target/$editor_dir/workflows/$basename" ]]; then
                    cp "$file" "$target/$editor_dir/workflows/"
                    [[ "$verbose" == true ]] && print_success "$basename"
                    ((count++))
                fi
            fi
        done
    fi
    print_info "$count $(L "workflows_copied")"
}

_copy_rules() {
    local target="$1"
    local editor="$2"
    local ios_mode="$3"
    local verbose="${4:-false}"

    print_header "üìè $(L "rules")"
    
    # Determine directory based on editor
    local editor_dir=""
    case "$editor" in
        cursor)
            editor_dir=".cursor"
            ;;
        windsurf)
            editor_dir=".windsurf"
            ;;
        *)
            print_error "$(L "invalid_editor")"
            return 1
            ;;
    esac
    
    mkdir -p "$target/$editor_dir/rules"

    # Use rules from the selected language folder
    local rules_src="$LIB_DIR/rules/$LANG_CODE"
    # Fallback to English if the specific language folder doesn't exist
    if [[ ! -d "$rules_src" ]]; then
        rules_src="$LIB_DIR/rules/en"
    fi

    # Generic rules
    local generic_rules=("api-design-guidelines.md" "accessibility-guidelines.md")
    local count=0

    for rule in "${generic_rules[@]}"; do
        if [[ -f "$rules_src/$rule" ]]; then
            cp "$rules_src/$rule" "$target/$editor_dir/rules/"
            [[ "$verbose" == true ]] && print_success "$rule"
            ((count++))
        fi
    done

    # iOS rules
    if [[ "$ios_mode" == true ]]; then
        local ios_rules=("swift-coding-style.md" "swift-concurrency.md" "makefile-usage.md")
        for rule in "${ios_rules[@]}"; do
            if [[ -f "$rules_src/$rule" ]]; then
                cp "$rules_src/$rule" "$target/$editor_dir/rules/"
                [[ "$verbose" == true ]] && print_success "$rule (iOS)"
                ((count++))
            fi
        done
    fi

    print_info "$count $(L "rules_copied")"
}

_copy_templates() {
    local target="$1"
    local verbose="${2:-false}"
    local overwrite="${3:-false}"

    print_header "üìÑ $(L "templates")"
    mkdir -p "$target/_docs/templates"
    mkdir -p "$target/_docs/specs"

    # Use templates from the selected language folder
    local template_src="$LIB_DIR/templates/$LANG_CODE"
    # Fallback to English if the specific language folder doesn't exist
    if [[ ! -d "$template_src" ]]; then
        template_src="$LIB_DIR/templates/en"
    fi

    local count=0
    if [[ -d "$template_src" ]]; then
        for file in "$template_src"/*.md; do
            if [[ -f "$file" ]]; then
                local basename=$(basename "$file")
                if [[ "$overwrite" == true || ! -f "$target/_docs/templates/$basename" ]]; then
                    cp "$file" "$target/_docs/templates/"
                    [[ "$verbose" == true ]] && print_success "$basename"
                    ((count++))
                fi
            fi
        done
    fi
    print_info "$count $(L "templates_copied")"
}

_copy_scripts() {
    local target="$1"
    local verbose="${2:-false}"

    print_header "üîß Scripts"
    mkdir -p "$target/_docs/scripts/bash"

    local count=0
    for file in "$LIB_DIR/scripts"/*.sh; do
        if [[ -f "$file" ]]; then
            cp "$file" "$target/_docs/scripts/bash/"
            chmod +x "$target/_docs/scripts/bash/$(basename "$file")"
            [[ "$verbose" == true ]] && print_success "$(basename "$file")"
            ((count++))
        fi
    done
    print_info "$count $(L "scripts_copied")"
}

_copy_documentation() {
    local target="$1"
    local ios_mode="$2"
    local verbose="${3:-false}"

    print_header "üìö $(L "documentation")"
    mkdir -p "$target/_docs"

    if [[ -f "$LIB_DIR/../docs/SPECSWIFT-WORKFLOWS.md" ]]; then
        cp "$LIB_DIR/../docs/SPECSWIFT-WORKFLOWS.md" "$target/_docs/"
        print_success "SPECSWIFT-WORKFLOWS.md"
    fi
}

_create_makefile() {
    local target="$1"
    local ios_mode="$2"
    local project_name="${3:-YourApp}"
    local xcode_template="${4:-}"

    if [[ -f "$target/Makefile" ]]; then
        return
    fi

    print_header "‚öôÔ∏è  Makefile"

    # Determine destination based on template
    local destination="platform=iOS\\ Simulator,name=iPhone\\ 16,OS=latest"
    if [[ "$xcode_template" == "swiftui-macos" ]]; then
        destination="platform=macOS"
    fi

    if [[ "$ios_mode" == true ]]; then
        local safe_project_name=$(echo "$project_name" | sed 's/[^a-zA-Z0-9]//g')
        cat > "$target/Makefile" << MAKEFILE
# iOS/macOS Project Makefile
# Generated by SpecSwift CLI

SCHEME = $safe_project_name
PROJECT = $safe_project_name.xcodeproj
DESTINATION = $destination

.PHONY: help build test clean

help:
	@echo "Available commands:"
	@echo "  make build  - Project build"
	@echo "  make test   - Run tests"
	@echo "  make clean  - Clean artifacts"

build:
	@set -o pipefail && xcodebuild \\
		-project "\$(PROJECT)" \\
		-scheme "\$(SCHEME)" \\
		-destination "\$(DESTINATION)" \\
		build | xcbeautify || xcodebuild \\
		-project "\$(PROJECT)" \\
		-scheme "\$(SCHEME)" \\
		-destination "\$(DESTINATION)" \\
		build

test:
	@set -o pipefail && xcodebuild \\
		-project "\$(PROJECT)" \\
		-scheme "\$(SCHEME)" \\
		-destination "\$(DESTINATION)" \\
		test | xcbeautify || xcodebuild \\
		-project "\$(PROJECT)" \\
		-scheme "\$(SCHEME)" \\
		-destination "\$(DESTINATION)" \\
		test

clean:
	@xcodebuild clean -project "\$(PROJECT)" -scheme "\$(SCHEME)"
	@rm -rf DerivedData .build
MAKEFILE
    else
        cat > "$target/Makefile" << 'MAKEFILE'
# Project Makefile
# Customize for your project

.PHONY: help build test clean

help:
	@echo "Available commands:"
	@echo "  make build  - Project build"
	@echo "  make test   - Run tests"
	@echo "  make clean  - Clean artifacts"

build:
	@echo "Configure the build command for your project"

test:
	@echo "Configure the test command for your project"

clean:
	@echo "Configure the clean command for your project"
MAKEFILE
    fi

    print_success "$(L "makefile_created")"
}

# =============================================================================
# Xcode Project Creation
# =============================================================================
_create_xcode_project() {
    local target="$1"
    local template="$2"
    local project_name="$3"
    local bundle_prefix="$4"
    local verbose="${5:-false}"

    # Check if xcodegen is installed
    local has_xcodegen=true
    if ! command -v xcodegen &> /dev/null; then
        has_xcodegen=false
    fi

    # Validate template
    local template_dir="$LIB_DIR/xcode-templates/$template"
    if [[ ! -d "$template_dir" ]]; then
        print_error "$(L "template_not_found"): $template"
        echo ""
        echo "$(L "available_templates"):"
        for dir in "$LIB_DIR/xcode-templates"/*/; do
            if [[ -d "$dir" ]]; then
                echo "  - $(basename "$dir")"
            fi
        done
        return 1
    fi

    print_header "üì± $(L "xcode_project")"
    print_info "$(L "generating_xcode_project"): $template"

    # Copy template files
    cp -R "$template_dir"/* "$target/"

    # Replace placeholders in all files
    local safe_project_name=$(echo "$project_name" | sed 's/[^a-zA-Z0-9]//g')
    local safe_bundle_prefix=$(echo "$bundle_prefix" | sed 's/[^a-zA-Z0-9]//g' | tr '[:upper:]' '[:lower:]')

    # Find and replace in all text files
    find "$target" -type f \( -name "*.swift" -o -name "*.yml" -o -name "*.plist" -o -name "*.entitlements" \) | while read -r file; do
        if [[ -f "$file" ]]; then
            sed -i '' "s/{{PROJECT_NAME}}/$safe_project_name/g" "$file" 2>/dev/null || true
            sed -i '' "s/{{BUNDLE_PREFIX}}/$safe_bundle_prefix/g" "$file" 2>/dev/null || true
        fi
    done

    # Rename files that contain {{PROJECT_NAME}} in their name
    find "$target" -depth -name "*{{PROJECT_NAME}}*" | while read -r file; do
        local newname=$(echo "$file" | sed "s/{{PROJECT_NAME}}/$safe_project_name/g")
        mv "$file" "$newname" 2>/dev/null || true
    done

    # Run xcodegen if available
    cd "$target"
    if [[ "$has_xcodegen" == true ]]; then
        if xcodegen generate --quiet 2>/dev/null; then
            print_success "$(L "xcode_project_created"): $safe_project_name.xcodeproj"
            [[ "$verbose" == true ]] && print_info "Template: $template"
        else
            # Try without --quiet for older versions
            if xcodegen generate 2>/dev/null; then
                print_success "$(L "xcode_project_created"): $safe_project_name.xcodeproj"
            else
                print_error "xcodegen failed"
                return 1
            fi
        fi
    else
        print_warning "$(L "xcodegen_not_found")"
        print_info "Source files created. Run 'xcodegen generate' after installing xcodegen."
        print_dim "  brew install xcodegen"
    fi

    return 0
}

_init_git() {
    local target="$1"

    print_header "üîÄ Git"

    if [[ -d "$target/.git" ]]; then
        print_info "$(L "git_repo_exists")"
        return
    fi

    cd "$target"
    git init -q
    print_success "$(L "repo_initialized")"

    if [[ ! -f ".gitignore" ]]; then
        cat > ".gitignore" << 'GITIGNORE'
# macOS
.DS_Store
*.swp

# IDE
.vscode/
.idea/

# Build
build/
.build/
DerivedData/

# Dependencies
node_modules/
Pods/

# Environment
.env
.env.local
GITIGNORE
        print_success "$(L "gitignore_created")"
    fi
}

_print_init_summary() {
    local target="$1"
    local ios_mode="$2"
    local xcode_template="${3:-}"
    local project_name="${4:-}"
    local editor="${5:-windsurf}"

    echo ""
    print_header "‚úÖ $(L "project_created")"
    echo ""
    echo -e "${BOLD}$(L "structure"):${NC}"
    echo "  $target/"
    
    # Show Xcode project if created
    if [[ -n "$xcode_template" && -d "$target/$project_name.xcodeproj" ]]; then
        echo "  ‚îú‚îÄ‚îÄ $project_name.xcodeproj"
        echo "  ‚îú‚îÄ‚îÄ Sources/"
        echo "  ‚îú‚îÄ‚îÄ Tests/"
    fi
    
    # Show editor directory
    local editor_dir=""
    case "$editor" in
        cursor)
            editor_dir=".cursor"
            ;;
        windsurf)
            editor_dir=".windsurf"
            ;;
    esac
    
    echo "  ‚îú‚îÄ‚îÄ $editor_dir/"
    echo "  ‚îÇ   ‚îú‚îÄ‚îÄ workflows/    $(ls -1 "$target/$editor_dir/workflows" 2>/dev/null | wc -l | tr -d ' ') $(L "files")"
    echo "  ‚îÇ   ‚îî‚îÄ‚îÄ rules/        $(ls -1 "$target/$editor_dir/rules" 2>/dev/null | wc -l | tr -d ' ') $(L "files")"
    echo "  ‚îú‚îÄ‚îÄ _docs/"
    echo "  ‚îÇ   ‚îú‚îÄ‚îÄ templates/"
    echo "  ‚îÇ   ‚îú‚îÄ‚îÄ scripts/"
    echo "  ‚îÇ   ‚îî‚îÄ‚îÄ specs/"
    echo "  ‚îú‚îÄ‚îÄ Makefile"
    echo "  ‚îî‚îÄ‚îÄ .gitignore"
    echo ""
    echo -e "${BOLD}$(L "next_steps"):${NC}"
    
    local editor_cmd=""
    case "$editor" in
        cursor)
            editor_cmd="cursor ."
            ;;
        windsurf)
            editor_cmd="windsurf ."
            ;;
    esac
    
    if [[ -n "$xcode_template" ]]; then
        echo "  1. cd $target"
        echo "  2. open $project_name.xcodeproj  # or: $editor_cmd"
        echo -e "  3. ${CYAN}/specswift.constitution${NC} - $(L "run_in_ide")"
        echo -e "  4. ${CYAN}/specswift.create-prd${NC} - $(L "run_to_create_feature")"
    else
        echo "  1. cd $target"
        echo "  2. $editor_cmd"
        echo -e "  3. ${CYAN}/specswift.constitution${NC} - $(L "run_in_ide")"
        echo -e "  4. ${CYAN}/specswift.create-prd${NC} - $(L "run_to_create_feature")"
    fi
}

_print_install_summary() {
    local target="$1"
    local editor="${2:-windsurf}"

    echo ""
    print_header "‚úÖ $(L "specswift_installed")"
    echo ""
    echo -e "${BOLD}$(L "next_steps"):${NC}"
    
    local editor_cmd=""
    case "$editor" in
        cursor)
            editor_cmd="cursor ."
            ;;
        windsurf)
            editor_cmd="windsurf ."
            ;;
    esac
    
    echo "  1. $editor_cmd"
    echo -e "  2. ${CYAN}/specswift.constitution${NC} - $(L "run_in_ide")"
    echo -e "  3. ${CYAN}/specswift.create-prd${NC} - $(L "to_create_new_feature")"
    echo ""
    echo -e "$(L "documentation"): ${CYAN}_docs/SPECSWIFT-WORKFLOWS.md${NC}"
}

# =============================================================================
# Main
# =============================================================================

# Parse global --lang option before main command
_parse_global_options() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --lang)
                if [[ -n "$2" && "$2" =~ ^(en|pt)$ ]]; then
                    LANG_CODE="$2"
                    shift 2
                else
                    echo "Invalid language. Use: --lang en or --lang pt"
                    exit 1
                fi
                ;;
            *)
                REMAINING_ARGS+=("$1")
                shift
                ;;
        esac
    done
}

REMAINING_ARGS=()
_parse_global_options "$@"
set -- "${REMAINING_ARGS[@]}"

main() {
    local command="${1:-help}"
    shift 2>/dev/null || true

    case "$command" in
        init)
            cmd_init "$@"
            ;;
        install)
            cmd_install "$@"
            ;;
        update)
            cmd_update "$@"
            ;;
        doctor)
            cmd_doctor "$@"
            ;;
        version|--version|-V)
            show_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "$(L "unknown_command"): $command"
            echo "$(L "run_help")"
            exit 1
            ;;
    esac
}

main "$@"
