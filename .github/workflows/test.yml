name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-scripts:
    name: Lint Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      
      - name: Run shellcheck on scripts
        run: |
          shellcheck -S error bin/specswift
          shellcheck -S error install.sh scripts/validate-workflows.sh
          shellcheck -S error -x lib/scripts/*.sh
          shellcheck -S error -x _docs/scripts/bash/*.sh

  validate-workflow-consistency:
    name: Validate Workflow Consistency
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Run workflow validation
        run: |
          chmod +x scripts/validate-workflows.sh
          ./scripts/validate-workflows.sh

  test-cli-commands:
    name: Test CLI Commands
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install BATS
        run: |
          sudo apt-get update
          sudo apt-get install -y bats
      
      - name: Run BATS tests
        run: |
          chmod +x bin/specswift
          bats tests/

  test-installation:
    name: Test Installation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Test installation
        run: |
          chmod +x install.sh
          ./install.sh --local --prefix /tmp/specswift-test
          
      - name: Verify installed CLI works
        run: |
          /tmp/specswift-test/bin/specswift --version
          /tmp/specswift-test/bin/specswift help
      
      - name: Test uninstallation
        run: |
          ./install.sh --uninstall --prefix /tmp/specswift-test
      
      - name: Verify files are removed
        run: |
          if [ -d "/tmp/specswift-test" ]; then
            echo "Error: Installation directory still exists"
            exit 1
          fi

  verify-version-consistency:
    name: Verify Version Consistency
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Extract version from VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version from VERSION file: $VERSION"
      
      - name: Verify bin/specswift reports correct version
        run: |
          VERSION_FILE=$(cat VERSION | tr -d '[:space:]')
          VERSION_BIN=$(./bin/specswift --version | sed 's/SpecSwift CLI v//')
          if [ "$VERSION_FILE" != "$VERSION_BIN" ]; then
            echo "Error: Version mismatch"
            echo "VERSION file: $VERSION_FILE"
            echo "bin/specswift: $VERSION_BIN"
            exit 1
          fi
          echo "✓ bin/specswift version matches: $VERSION_BIN"
      
      - name: Verify install.sh reads version dynamically
        run: |
          # Verify install.sh contains the logic to read VERSION file
          if grep -q 'VERSION="$(cat "$VERSION_FILE"' install.sh; then
            echo "✓ install.sh reads VERSION file dynamically"
          else
            echo "Error: install.sh does not appear to read VERSION file dynamically"
            exit 1
          fi
